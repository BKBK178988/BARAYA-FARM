<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title data-lang="title">Checkout - BARAYA FARM</title>
  <link rel="stylesheet" href="checkout_farm.css">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<header>
  <h1 data-lang="checkout-title">üõí Checkout</h1>
  <p data-lang="checkout-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
  <div class="language-switcher">
    <button onclick="changeLanguage('th')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
    <button onclick="changeLanguage('en')">üá¨üáß English</button>
    <button onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</button>
  </div>
</header>

<section class="checkout-form">
  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
  <label for="customer-name" data-lang="label-name">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
  <input type="text" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>

  <label for="customer-address" data-lang="label-address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</label>
  <textarea id="customer-address" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" required></textarea>

  <label for="customer-phone" data-lang="label-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label>
  <input type="text" id="customer-phone" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required>

  <label for="customer-email" data-lang="label-email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
  <input type="email" id="customer-email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
  <h2 data-lang="cart-items-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <ul id="checkout-cart"></ul>
  <p id="checkout-total"></p>

  <!-- QR Code PromptPay -->
  <h3 data-lang="payment-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h3>
  <img id="promptpay-qr" alt="QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå" style="max-width:200px;">
  <p data-lang="payment-subtitle">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</p>

  <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ -->
  <label for="slipUpload" data-lang="upload-slip">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
  <input type="file" id="slipUpload" accept="image/*">
  <div id="slipPreviewContainer" class="hidden">
    <img id="slipPreview" style="max-width:200px;">
  </div>

  <button onclick="confirmOrder()" data-lang="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
</section>

/************************************************
 * EmailJS Init
 ************************************************/
emailjs.init("EUHurGnUrY9Q-SbaO");

<script>
/************************************************
 * 1) ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ (‡πÑ‡∏ó‡∏¢, ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡∏à‡∏µ‡∏ô)
 ************************************************/
const translations = {
  th: {
    "title": "Checkout - BARAYA FARM",
    "checkout-title": "üõí Checkout",
    "checkout-subtitle": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
    "label-name": "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:",
    "label-address": "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:",
    "label-phone": "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:",
    "label-email": "‡∏≠‡∏µ‡πÄ‡∏°‡∏•:",
    "cart-items-title": "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
    "payment-title": "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå",
    "payment-subtitle": "‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°",
    "upload-slip": "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:",
    "btn-confirm": "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
    "empty-cart-alert": "‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô",
    "form-incomplete": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ!",
    "order-success": "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
    "promptpay-error": "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÑ‡∏î‡πâ",
    "currency": "‡∏ö‡∏≤‡∏ó"
  },
  en: {
    "title": "Checkout - BARAYA FARM",
    "checkout-title": "üõí Checkout",
    "checkout-subtitle": "Please fill in your shipping details",
    "label-name": "Full Name:",
    "label-address": "Shipping Address:",
    "label-phone": "Phone Number:",
    "label-email": "Email:",
    "cart-items-title": "Your Cart Items",
    "payment-title": "Pay via PromptPay",
    "payment-subtitle": "Scan the QR Code above to pay the total amount",
    "upload-slip": "Upload Payment Slip:",
    "btn-confirm": "Confirm Order",
    "empty-cart-alert": "Your cart is empty! Please select products first.",
    "form-incomplete": "Please fill in all fields and upload the payment slip!",
    "order-success": "Order placed successfully! Thank you!",
    "promptpay-error": "Unable to generate PromptPay QR code",
    "currency": "THB"
  },
  zh: {
    "title": "ÁªìË¥¶ - BARAYA FARM",
    "checkout-title": "üõí ÁªìË¥¶",
    "checkout-subtitle": "ËØ∑Â°´ÂÜôÈÄÅË¥ß‰ø°ÊÅØ",
    "label-name": "ÂßìÂêç:",
    "label-address": "ÈÄÅË¥ßÂú∞ÂùÄ:",
    "label-phone": "ÁîµËØùÂè∑Á†Å:",
    "label-email": "ÁîµÂ≠êÈÇÆ‰ª∂:",
    "cart-items-title": "Ë¥≠Áâ©ËΩ¶ÂïÜÂìÅ",
    "payment-title": "ÈÄöËøá PromptPay ‰ªòÊ¨æ",
    "payment-subtitle": "ËØ∑Êâ´Êèè‰∏äÊñπÁöÑ‰∫åÁª¥Á†ÅÊîØ‰ªòÊÄªÈáëÈ¢ù",
    "upload-slip": "‰∏ä‰º†ÊîØ‰ªòÂá≠ËØÅ:",
    "btn-confirm": "Á°ÆËÆ§ËÆ¢Âçï",
    "empty-cart-alert": "Ë¥≠Áâ©ËΩ¶‰∏∫Á©∫ÔºÅËØ∑ÂÖàÈÄâÊã©ÂïÜÂìÅ„ÄÇ",
    "form-incomplete": "ËØ∑Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµÂπ∂‰∏ä‰º†‰ªòÊ¨æÂá≠ËØÅÔºÅ",
    "order-success": "ËÆ¢ÂçïÂ∑≤ÊàêÂäüÔºÅÊÑüË∞¢ÊÇ®ÁöÑË¥≠‰π∞ÔºÅ",
    "promptpay-error": "Êó†Ê≥ïÁîüÊàê PromptPay ‰∫åÁª¥Á†Å",
    "currency": "Ê≥∞Èì¢"
  }
};

function changeLanguage(lang) {
  localStorage.setItem("language", lang);
  document.querySelectorAll("[data-lang]").forEach(el => {
    const key = el.dataset.lang;
    if (translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });
}

/************************************************
 * 2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + ‡∏™‡∏£‡πâ‡∏≤‡∏á PromptPay QR
 ************************************************/
document.addEventListener("DOMContentLoaded", function() {
  // ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏©‡∏≤
  const savedLang = localStorage.getItem("language") || "th";
  changeLanguage(savedLang);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å localStorage
  let cartFarm = JSON.parse(localStorage.getItem("cartFarm")) || [];
  let totalPriceFarm = localStorage.getItem("totalPriceFarm") || 0;

  // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ farm.html
  if (cartFarm.length === 0) {
    alert(translations[savedLang]["empty-cart-alert"]);
    window.location.href = "farm.html";
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  let checkoutCart = document.getElementById("checkout-cart");
  let checkoutTotal = document.getElementById("checkout-total");
  cartFarm.forEach(item => {
    let li = document.createElement("li");
    li.textContent = `${item.name} x${item.quantity} = ${item.price * item.quantity} ${translations[savedLang]["currency"]}`;
    checkoutCart.appendChild(li);
  });
  checkoutTotal.textContent = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ${totalPriceFarm} ${translations[savedLang]["currency"]}`;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code PromptPay
  let promptpayNumber = "0639392988"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô PromptPay ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  let qrImage = document.getElementById("promptpay-qr");
  let amountForQR = parseFloat(totalPriceFarm) || 0;
  qrImage.src = `https://promptpay.io/${promptpayNumber}/${amountForQR}.png`;
  qrImage.onerror = function() {
    console.error(translations[savedLang]["promptpay-error"]);
  };

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
  let slipUpload = document.getElementById("slipUpload");
  slipUpload.addEventListener("change", function() {
    let file = slipUpload.files[0];
    if (!file) return;
    let slipPreviewContainer = document.getElementById("slipPreviewContainer");
    let slipPreview = document.getElementById("slipPreview");
    slipPreviewContainer.classList.remove("hidden");
    slipPreview.src = URL.createObjectURL(file);
  });
});

/************************************************
 * 3) ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô EmailJS)
 ************************************************/
function confirmOrder() {
  let lang = localStorage.getItem("language") || "th";
  let totalPriceFarm = localStorage.getItem("totalPriceFarm") || 0;

  let name = document.getElementById("customer-name").value.trim();
  let address = document.getElementById("customer-address").value.trim();
  let phone = document.getElementById("customer-phone").value.trim();
  let email = document.getElementById("customer-email").value.trim();
  let slipFile = document.getElementById("slipUpload").files[0];

  if (!name || !address || !phone || !email || !slipFile) {
    alert(translations[lang]["form-incomplete"]);
    return;
  }

  let cartFarm = JSON.parse(localStorage.getItem("cartFarm")) || [];
  let orderDetails = cartFarm.map(item => `${item.name} x${item.quantity} = ${item.price * item.quantity} ${translations[lang]["currency"]}`).join("\n");
  let order_id = "BRY-" + Math.floor(100000 + Math.random() * 900000);

  const reader = new FileReader();
  reader.onload = function(event) {
    const base64Slip = event.target.result;

    const templateParams = {
      name: name,
      address: address,
      phone: phone,
      email: email,
      order: orderDetails,
      total: totalPriceFarm,
      order_id: order_id,
      slip_image: base64Slip
    };

    emailjs.send("service_8arkcft", "template_7s28pv9", templateParams)
      .then(function(response) {
        alert(translations[lang]["order-success"]);
        localStorage.removeItem("cartFarm");
        localStorage.removeItem("totalPriceFarm");
        window.location.href = "farm.html";
      }, function(error) {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + JSON.stringify(error));
      });
  };
  reader.readAsDataURL(slipFile);
}
</script>

</body>
</html>
