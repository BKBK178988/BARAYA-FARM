<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title data-lang="title">Checkout - BARAYA FARM</title>
  <link rel="stylesheet" href="checkout_farm.css">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<header>
  <h1 data-lang="checkout-title">üõí Checkout</h1>
  <p data-lang="checkout-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
  <div class="language-switcher">
    <button onclick="changeLanguage('th')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
    <button onclick="changeLanguage('en')">üá¨üáß English</button>
    <button onclick="changeLanguage('zh')">üá®üá≥ ‰∏≠Êñá</button>
  </div>
</header>

<section class="checkout-form">
  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
  <label for="customer-name" data-lang="label-name">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
  <input type="text" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>

  <label for="customer-address" data-lang="label-address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</label>
  <textarea id="customer-address" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" required></textarea>

  <label for="customer-phone" data-lang="label-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label>
  <input type="text" id="customer-phone" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required>

  <label for="customer-email" data-lang="label-email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
  <input type="email" id="customer-email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
  <h2 data-lang="cart-items-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <ul id="checkout-cart"></ul>
  <p id="checkout-total"></p>

  <!-- QR Code PromptPay -->
  <h3 data-lang="payment-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h3>
  <img id="promptpay-qr" alt="QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå" style="max-width:200px;">
  <p data-lang="payment-subtitle">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</p>

  <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ -->
  <label for="slipUpload" data-lang="upload-slip">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
  <input type="file" id="slipUpload" accept="image/*">
  <div id="slipPreviewContainer" class="hidden">
    <img id="slipPreview" style="max-width:200px;">
  </div>

  <button onclick="confirmOrder()" data-lang="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
</section>

<script>
// EmailJS Init
emailjs.init("EUHurGnUrY9Q-SbaO");

// ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤
const translations = {
  th: {
    "title": "Checkout - BARAYA FARM",
    "checkout-title": "üõí Checkout",
    "checkout-subtitle": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
    "label-name": "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:",
    "label-address": "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:",
    "label-phone": "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:",
    "label-email": "‡∏≠‡∏µ‡πÄ‡∏°‡∏•:",
    "cart-items-title": "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
    "payment-title": "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå",
    "payment-subtitle": "‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°",
    "upload-slip": "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:",
    "btn-confirm": "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
    "empty-cart-alert": "‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô",
    "form-incomplete": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ!",
    "order-success": "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
    "promptpay-error": "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÑ‡∏î‡πâ",
    "currency": "‡∏ö‡∏≤‡∏ó",
    "total-price": "‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
  },
  en: {
    "title": "Checkout - BARAYA FARM",
    "checkout-title": "üõí Checkout",
    "checkout-subtitle": "Please fill in your shipping details",
    "label-name": "Full Name:",
    "label-address": "Shipping Address:",
    "label-phone": "Phone Number:",
    "label-email": "Email:",
    "cart-items-title": "Your Cart Items",
    "payment-title": "Pay via PromptPay",
    "payment-subtitle": "Scan the QR Code above to pay the total amount",
    "upload-slip": "Upload Payment Slip:",
    "btn-confirm": "Confirm Order",
    "empty-cart-alert": "Your cart is empty! Please select products first.",
    "form-incomplete": "Please fill in all fields and upload the payment slip!",
    "order-success": "Order placed successfully! Thank you!",
    "promptpay-error": "Unable to generate PromptPay QR code",
    "currency": "THB",
    "total-price": "Total"
  },
  zh: {
    "title": "ÁªìË¥¶ - BARAYA FARM",
    "checkout-title": "üõí ÁªìË¥¶",
    "checkout-subtitle": "ËØ∑Â°´ÂÜôÈÄÅË¥ß‰ø°ÊÅØ",
    "label-name": "ÂßìÂêç:",
    "label-address": "ÈÄÅË¥ßÂú∞ÂùÄ:",
    "label-phone": "ÁîµËØùÂè∑Á†Å:",
    "label-email": "ÁîµÂ≠êÈÇÆ‰ª∂:",
    "cart-items-title": "Ë¥≠Áâ©ËΩ¶ÂïÜÂìÅ",
    "payment-title": "ÈÄöËøá PromptPay ‰ªòÊ¨æ",
    "payment-subtitle": "ËØ∑Êâ´Êèè‰∏äÊñπÁöÑ‰∫åÁª¥Á†ÅÊîØ‰ªòÊÄªÈáëÈ¢ù",
    "upload-slip": "‰∏ä‰º†ÊîØ‰ªòÂá≠ËØÅ:",
    "btn-confirm": "Á°ÆËÆ§ËÆ¢Âçï",
    "empty-cart-alert": "Ë¥≠Áâ©ËΩ¶‰∏∫Á©∫ÔºÅËØ∑ÂÖàÈÄâÊã©ÂïÜÂìÅ„ÄÇ",
    "form-incomplete": "ËØ∑Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµÂπ∂‰∏ä‰º†‰ªòÊ¨æÂá≠ËØÅÔºÅ",
    "order-success": "ËÆ¢ÂçïÂ∑≤ÊàêÂäüÔºÅÊÑüË∞¢ÊÇ®ÁöÑË¥≠‰π∞ÔºÅ",
    "promptpay-error": "Êó†Ê≥ïÁîüÊàê PromptPay ‰∫åÁª¥Á†Å",
    "currency": "Ê≥∞Èì¢",
    "total-price": "ÊÄª‰ª∑"
  }
};

function changeLanguage(lang) {
  localStorage.setItem("language", lang);
  document.querySelectorAll("[data-lang]").forEach(el => {
    const key = el.dataset.lang;
    if (translations[lang][key]) el.textContent = translations[lang][key];
  });
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + QR
document.addEventListener("DOMContentLoaded", function() {
  const savedLang = localStorage.getItem("language") || "th";
  changeLanguage(savedLang);

  let cartFarm = JSON.parse(localStorage.getItem("cartFarm")) || [];
  if (cartFarm.length === 0) {
    alert(translations[savedLang]["empty-cart-alert"]);
    window.location.href = "farm.html";
    return;
  }

  let checkoutCart = document.getElementById("checkout-cart");
  let checkoutTotal = document.getElementById("checkout-total");
  checkoutCart.innerHTML = "";

  let sumTotal = 0;

  cartFarm.forEach(item => {
    const itemKey = item.key || item.name || "unknown";
    const itemQty = item.quantity || 1;
    const itemPrice = item.price || 0;
    const itemTotal = itemPrice * itemQty;
    sumTotal += itemTotal;

    const li = document.createElement("li");
    li.textContent = `${itemKey} x ${itemQty} = ${itemTotal.toLocaleString()} ${translations[savedLang]["currency"]}`;
    checkoutCart.appendChild(li);
  });

  checkoutTotal.textContent = `${translations[savedLang]["total-price"]}: ${sumTotal.toLocaleString()} ${translations[savedLang]["currency"]}`;

  localStorage.setItem("totalPriceFarm", sumTotal);

  // QR PromptPay
  const promptpayNumber = "0639392988"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const qrImage = document.getElementById("promptpay-qr");
  qrImage.src = `https://promptpay.io/${promptpayNumber}/${sumTotal}.png`;
  qrImage.onerror = function() { console.error(translations[savedLang]["promptpay-error"]); };

  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ
  const slipUpload = document.getElementById("slipUpload");
  slipUpload.addEventListener("change", function() {
    const file = slipUpload.files[0];
    if (!file) return;
    const slipPreviewContainer = document.getElementById("slipPreviewContainer");
    const slipPreview = document.getElementById("slipPreview");
    slipPreviewContainer.classList.remove("hidden");
    slipPreview.src = URL.createObjectURL(file);
  });
});

// ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ + EmailJS
function confirmOrder() {
  let lang = localStorage.getItem("language") || "th";
  let totalPriceFarm = localStorage.getItem("totalPriceFarm") || 0;

  let name = document.getElementById("customer-name").value.trim();
  let address = document.getElementById("customer-address").value.trim();
  let phone = document.getElementById("customer-phone").value.trim();
  let email = document.getElementById("customer-email").value.trim();
  let slipFile = document.getElementById("slipUpload").files[0];

  if (!name || !address || !phone || !email || !slipFile) {
    alert(translations[lang]["form-incomplete"]);
    return;
  }

  let cartFarm = JSON.parse(localStorage.getItem("cartFarm")) || [];
  let orderDetails = cartFarm.map(item => {
    const itemName = item.name || item.key || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
    const itemPrice = item.price || 0;
    const itemQty = item.quantity || 1;
    return `${itemName} x ${itemQty} = ${itemPrice * itemQty} ${translations[lang]["currency"]}`;
  }).join("\n");

  let order_id = "BRY-" + Math.floor(100000 + Math.random() * 900000);

  const MAX_WIDTH = 400;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const scaleSize = MAX_WIDTH / img.width;
      canvas.width = MAX_WIDTH;
      canvas.height = img.height * scaleSize;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const compressedBase64 = canvas.toDataURL("image/jpeg", 0.7);

      const templateParams = {
        name: name,
        address: address,
        phone: phone,
        email: email,
        order: orderDetails,
        total: totalPriceFarm,
        order_id: order_id,
        slip_image: compressedBase64
      };

      emailjs.send("service_8arkcft", "template_7s28pv9", templateParams)
        .then(function(response) {
          alert(translations[lang]["order-success"]);
          localStorage.removeItem("cartFarm");
          localStorage.removeItem("totalPriceFarm");
          window.location.href = "farm.html";
        }, function(error) {
          alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + JSON.stringify(error));
        });
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(slipFile);
}
</script>

</body>
</html>
